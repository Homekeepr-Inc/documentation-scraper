services:
  app:
    build: .
    platform: linux/amd64
    env_file:
      - .env
    environment:
      - PROXY_PROFILE_NAMES=${PROXY_PROFILE_NAMES:-proxy_a,proxy_b}
      - PROXY_PROXY_A_SQUID_URL=http://squid-proxy-a:8888
      - PROXY_PROXY_A_PUBLIC_URL=${PROXY_A_PUBLIC_URL:-}
      - PROXY_PROXY_A_TYPE=${PROXY_A_TYPE:-HTTP}
      - PROXY_PROXY_B_SQUID_URL=http://squid-proxy-b:8888
      - PROXY_PROXY_B_PUBLIC_URL=${PROXY_B_PUBLIC_URL:-}
      - PROXY_PROXY_B_TYPE=${PROXY_B_TYPE:-HTTP}
    volumes:
      - manuals_data:/app/data
    command: ["./bin/start_with_proxy.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app_network
    depends_on:
      - squid-proxy-a
      - squid-proxy-b
    deploy:
      replicas: 4  # Scale to multiple instances for parallelism

  squid-proxy-a:
    build: ./squid
    env_file:
      - .env
    environment:
      - UPSTREAM_PROXY_URLS=${PROXY_A_PUBLIC_URL:-}
    networks:
      - app_network

  squid-proxy-b:
    build: ./squid
    env_file:
      - .env
    environment:
      - UPSTREAM_PROXY_URLS=${PROXY_B_PUBLIC_URL:-}
    networks:
      - app_network

  caddy:
    image: caddy:2
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME:-api.homekeepr.co}
      - TLS_DIRECTIVE=${TLS_DIRECTIVE:-tls /etc/caddy/cert.pem /etc/caddy/key.pem}
    working_dir: /etc/caddy
    ports:
      - "443:443"
    volumes:
      - ./caddy:/etc/caddy
      - ./caddy/logs:/var/log/caddy
    networks:
      - app_network

networks:
  app_network:
    driver: bridge

volumes:
  manuals_data:
    driver: local
