# Compose stack for documentation-scraper service.
#
# Network Architecture:
# ---------------------
# This service uses two networks for security isolation:
#
# 1. "internal" (bridge) - For intra-service communication only
#    - squid-proxy-a and squid-proxy-b ONLY connect here
#    - Not reachable from outside this compose stack
#    - Keeps proxy infrastructure isolated from external access
#
# 2. "documentation-scraper-network" (external) - For Caddy reverse proxy access
#    - Created externally: `docker network create documentation-scraper-network`
#    - Only the "app" service connects here (in addition to internal)
#    - Caddy (in VPS-Infra-Services) also connects to route external traffic
#    - Other services (homekeepr-outbound, temporal-jobs) CANNOT reach this network
#
# This ensures:
# - Squid proxies are never directly reachable from Caddy or other services
# - Only the app containers are exposed to the reverse proxy
# - Services in different repos are isolated from each other
#
# Note: With replicas: 4, containers are named documentation-scraper-app-1 through
# documentation-scraper-app-4, which Caddy load balances across.
#
services:
  app:
    build: .
    platform: linux/amd64
    env_file:
      - .env
    environment:
      - PROXY_PROFILE_NAMES=${PROXY_PROFILE_NAMES:-proxy_a,proxy_b}
      - PROXY_PROXY_A_SQUID_URL=http://squid-proxy-a:8888
      - PROXY_PROXY_A_PUBLIC_URL=${PROXY_A_PUBLIC_URL:-}
      - PROXY_PROXY_A_TYPE=${PROXY_A_TYPE:-HTTP}
      - PROXY_PROXY_B_SQUID_URL=http://squid-proxy-b:8888
      - PROXY_PROXY_B_PUBLIC_URL=${PROXY_B_PUBLIC_URL:-}
      - PROXY_PROXY_B_TYPE=${PROXY_B_TYPE:-HTTP}
    volumes:
      - manuals_data:/app/data
    command: ["./bin/start_with_proxy.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - internal                          # Can reach squid proxies
      - documentation-scraper-network     # Reachable by Caddy reverse proxy
    depends_on:
      - squid-proxy-a
      - squid-proxy-b
    deploy:
      replicas: 4  # Scale to multiple instances for parallelism

  squid-proxy-a:
    build: ./squid
    env_file:
      - .env
    environment:
      - UPSTREAM_PROXY_URLS=${PROXY_A_PUBLIC_URL:-}
    networks:
      - internal                # Internal only - not reachable from Caddy

  squid-proxy-b:
    build: ./squid
    env_file:
      - .env
    environment:
      - UPSTREAM_PROXY_URLS=${PROXY_B_PUBLIC_URL:-}
    networks:
      - internal                # Internal only - not reachable from Caddy

networks:
  internal:
    driver: bridge              # Private network for app <-> squid communication
  documentation-scraper-network:
    external: true              # Shared with Caddy in VPS-Infra-Services for reverse proxy

volumes:
  manuals_data:
    driver: local
